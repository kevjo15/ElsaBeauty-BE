<!DOCTYPE html>
<html>
  <head>
    <title>SignalR Chat Test</title>
    <style>
      .container {
        margin: 20px;
        font-family: Arial, sans-serif;
      }
      .input-group {
        margin: 10px 0;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
      .notification {
        margin: 5px 0;
        padding: 10px;
        background-color: #f0f8ff;
        border: 1px solid #b0e0e6;
        border-radius: 4px;
      }
      .timestamp {
        color: #666;
        font-size: 0.8em;
      }
      .login-section {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 5px;
      }
      .chat-section {
        display: none;
      }
      .error {
        color: red;
        margin: 5px 0;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
      }

      input[type="datetime-local"],
      input[type="date"],
      input[type="email"],
      input[type="password"],
      input[type="text"],
      select {
        padding: 8px;
        margin: 5px 0;
        min-width: 200px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .flex-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .flex-wrap button {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }

      .flex-wrap button:hover {
        background-color: #0056b3;
      }

      .flex-wrap button.active {
        background-color: #28a745;
      }

      .time-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #222;
      }

      .time-slots-grid button {
        padding: 10px 12px;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      .time-slots-grid button:hover {
        background-color: #0056b3;
        transform: scale(1.05);
      }

      .time-slots-grid button.active {
        background-color: #28a745;
      }

      .time-slots-grid button:focus {
        outline: 2px solid #ffd700;
      }

      button {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #serviceDetails {
        margin: 10px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      h3,
      h4 {
        color: #333;
        margin-top: 0;
      }

      .success {
        color: green;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loginSection" class="login-section">
        <h3>Login</h3>
        <div class="input-group">
          <label>Email:</label>
          <input type="email" id="email" placeholder="Enter your email" />
        </div>
        <div class="input-group">
          <label>Password:</label>
          <input
            type="password"
            id="password"
            placeholder="Enter your password"
          />
        </div>
        <button onclick="login()">Login</button>
        <div id="loginError" class="error"></div>
      </div>

      <div id="chatSection" class="chat-section">
        <h3>SignalR Test Dashboard</h3>

        <!-- Booking Test Section -->
        <div class="test-section">
          <h4>Test Booking Notification</h4>
          <div class="input-group">
            <label>Select Service:</label>
            <select id="serviceId" onchange="loadServiceDetails()">
              <option value="">Select a service</option>
            </select>
            <div id="serviceDetails"></div>
          </div>
          <div class="input-group">
            <label>Select Date:</label>
            <input
              type="date"
              id="bookingDate"
              onchange="loadAvailableSlots()"
              disabled
            />
          </div>
          <div id="timeSlotsContainer" style="display: none; margin-top: 10px">
            <label>Available Time Slots:</label>
            <div id="timeSlots" class="flex-wrap"></div>
          </div>
          <button
            onclick="createTestBooking()"
            id="bookButton"
            style="display: none"
          >
            Create Test Booking
          </button>
          <div id="bookingError" class="error"></div>
        </div>

        <!-- Sektion för avbokning & uppdatering -->
        <div class="test-section">
          <h4>Test Booking Cancellation & Update</h4>
          <!-- Avbokning -->
          <div class="input-group">
            <label>Booking ID:</label>
            <input type="text" id="bookingId" placeholder="Enter Booking ID" />
          </div>
          <button onclick="cancelBooking()">Cancel Booking</button>

          <!-- Uppdatering -->
          <div class="input-group">
            <label>Select Service:</label>
            <select id="serviceIdUpdate" onchange="loadServiceDetailsUpdate()">
              <option value="">Select a service</option>
            </select>
            <div id="serviceDetailsUpdate"></div>
          </div>
          <div class="input-group">
            <label>Select Date and Time:</label>
            <input
              type="datetime-local"
              id="bookingDateUpdate"
              onchange="loadAvailableSlotsUpdate()"
              disabled
            />
          </div>
          <div id="timeSlotsContainer" style="display: none; margin-top: 10px">
            <label>Available Time Slots:</label>
            <div id="timeSlots" class="time-slots-grid"></div>
          </div>
          <!-- Här är den uppdaterade knappen för updateBooking -->
          <button
            onclick="updateBooking()"
            id="bookButtonUpdate"
            style="display: none"
          >
            Update Booking
          </button>
          <div id="bookingErrorUpdate" class="error"></div>
        </div>

        <!-- Chat section -->
        <div class="test-section">
          <h4>Test Chat</h4>
          <div class="input-group">
            <label>Your User ID:</label>
            <span id="currentUserId"></span>
            <button onclick="logout()">Logout</button>
          </div>
          <div class="input-group">
            <label>Conversation ID (Guid):</label>
            <input
              type="text"
              id="conversationId"
              placeholder="Enter conversation ID"
            />
            <button onclick="joinConversation()">Join Conversation</button>
            <button onclick="leaveConversation()">Leave Conversation</button>
          </div>
          <div class="input-group">
            <label>Message:</label>
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message"
            />
            <button onclick="sendMessage()">Send Message</button>
          </div>
          <div>
            <h4>Messages:</h4>
            <div id="messagesList"></div>
          </div>
          <div>
            <h4>Notifications:</h4>
            <div id="notificationsList"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
      let currentUserId = null;
      let accessToken = null;
      let connection = null;
      let notificationConnection = null;
      let services = []; // Store all services
      let selectedService = null;

      function showLoginSection() {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("chatSection").style.display = "none";
      }

      function showChatSection() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("chatSection").style.display = "block";
      }

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        // Validate inputs
        if (!email) {
          document.getElementById("loginError").textContent =
            "Please enter your email";
          return;
        }

        if (!password) {
          document.getElementById("loginError").textContent =
            "Please enter your password";
          return;
        }

        // Basic email format validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          document.getElementById("loginError").textContent =
            "Please enter a valid email address";
          return;
        }

        try {
          document.getElementById("loginError").textContent = ""; // Clear previous errors
          const response = await fetch("/api/User/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Login failed");
          }

          const data = await response.json();
          accessToken = data.token;
          currentUserId = data.userId;

          document.getElementById("currentUserId").textContent = currentUserId;
          showChatSection();

          await initializeSignalRConnections();
          await loadServices();
        } catch (error) {
          console.error("Login error:", error);
          document.getElementById("loginError").textContent = error.message;
        }
      }

      function logout() {
        accessToken = null;
        currentUserId = null;
        if (connection) {
          connection.stop();
        }
        if (notificationConnection) {
          notificationConnection.stop();
        }
        showLoginSection();
      }

      async function initializeSignalRConnections() {
        try {
          // Initialize chat connection
          connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub", {
              accessTokenFactory: () => accessToken,
            })
            .withAutomaticReconnect()
            .build();

          // Initialize notification connection
          notificationConnection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub", {
              accessTokenFactory: () => accessToken,
            })
            .withAutomaticReconnect()
            .build();

          // Set up message handler
          connection.on("ReceiveMessage", (message) => {
            console.log("Received message:", message);
            const messageDiv = document.createElement("div");
            messageDiv.className = "message";
            const time = new Date(message.SentAt).toLocaleString("sv-SE", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            messageDiv.innerHTML = `
        <div>From ${message.SenderId}: ${message.Content}</div>
        <div class="timestamp">${time}</div>
      `;
            document.getElementById("messagesList").appendChild(messageDiv);
          });

          // Set up notification handler
          notificationConnection.on("ReceiveNotification", (notification) => {
            console.log("Received notification:", notification);
            const notificationDiv = document.createElement("div");
            notificationDiv.className = "notification";

            const time = new Date(notification.CreatedAt).toLocaleString(
              "sv-SE",
              {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
              }
            );

            // Identify notification type
            let typeText;
            switch (notification.Type) {
              case 0:
                typeText = "Bokningspåminnelse";
                break;
              case 1:
                typeText = "Ny bokning";
                break;
              case 2:
                typeText = "Avbokad bokning";
                break;
              case 3:
                typeText = "Meddelande";
                break;
              default:
                typeText = "Nytt";
            }

            // Add notification HTML
            notificationDiv.innerHTML = `
        <div>
          <strong>${notification.Title}</strong> (${typeText})
        </div>
        <div style="margin: 5px 0;">${notification.Message}</div>
        <div class="timestamp">${time}</div>
      `;

            // Append the notification to the notifications list
            const notificationsList =
              document.getElementById("notificationsList");
            notificationsList.insertBefore(
              notificationDiv,
              notificationsList.firstChild
            );
          });

          // Set up additional chat handlers
          connection.on("JoinedConversation", (conversationId) => {
            console.log("Joined conversation:", conversationId);
            document.getElementById("loginError").textContent = "";
          });

          connection.on("LeftConversation", (conversationId) => {
            console.log("Left conversation:", conversationId);
            document.getElementById("loginError").textContent = "";
          });

          // Start SignalR connections
          await connection.start();
          console.log("Connected to ChatHub");
          await notificationConnection.start();
          console.log("Connected to NotificationHub");

          // Set up reconnection handlers
          connection.onreconnecting((error) => {
            console.log("Reconnecting to ChatHub...", error);
          });
          connection.onreconnected((connectionId) => {
            console.log("Reconnected to ChatHub:", connectionId);
          });
          notificationConnection.onreconnecting((error) => {
            console.log("Reconnecting to NotificationHub...", error);
          });
          notificationConnection.onreconnected((connectionId) => {
            console.log("Reconnected to NotificationHub:", connectionId);
          });
        } catch (err) {
          console.error("Error connecting to SignalR:", err);
          throw err; // Re-throw to be caught by login
        }
      }

      async function joinConversation() {
        const conversationId = document.getElementById("conversationId").value;
        if (!conversationId) {
          document.getElementById("loginError").textContent =
            "Please enter a conversation ID";
          return;
        }

        try {
          await connection.invoke("JoinConversation", conversationId);
          console.log("Joined conversation:", conversationId);
          document.getElementById("loginError").textContent = "";
        } catch (err) {
          console.error(err);
          document.getElementById("loginError").textContent = err.message;
        }
      }

      async function leaveConversation() {
        const conversationId = document.getElementById("conversationId").value;
        if (!conversationId) {
          document.getElementById("loginError").textContent =
            "Please enter a conversation ID";
          return;
        }

        try {
          await connection.invoke("LeaveConversation", conversationId);
          console.log("Left conversation:", conversationId);
          document.getElementById("loginError").textContent = "";
        } catch (err) {
          console.error(err);
          document.getElementById("loginError").textContent = err.message;
        }
      }

      async function sendMessage() {
        const conversationId = document.getElementById("conversationId").value;
        const message = document.getElementById("messageInput").value;

        if (!conversationId) {
          document.getElementById("loginError").textContent =
            "Please enter a conversation ID";
          return;
        }

        if (!message.trim()) {
          document.getElementById("loginError").textContent =
            "Please enter a message";
          return;
        }

        try {
          await connection.invoke("SendMessage", message, conversationId);
          document.getElementById("messageInput").value = "";
          document.getElementById("loginError").textContent = "";
        } catch (err) {
          console.error(err);
          document.getElementById("loginError").textContent = err.message;
        }
      }

      async function loadServices() {
        try {
          const response = await fetch("/api/Service/GetAllServices", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to load services");
          }

          services = await response.json(); // Store services globally
          console.log("Loaded services:", services);

          // Hämta båda select-elementen
          const selectCreate = document.getElementById("serviceId");
          const selectUpdate = document.getElementById("serviceIdUpdate");

          // Funktion för att fylla på en select med tjänster
          const populateSelect = (selectElement) => {
            selectElement.innerHTML =
              '<option value="">Select a service</option>';
            services.forEach((service) => {
              const option = document.createElement("option");
              option.value = service.id; // GUID som värde
              option.textContent = service.name; // Namnet som visas
              selectElement.appendChild(option);
            });
          };

          if (selectCreate) {
            populateSelect(selectCreate);
          }
          if (selectUpdate) {
            populateSelect(selectUpdate);
          }
        } catch (error) {
          console.error("Error loading services:", error);
          // Visa felmeddelande på något av felen – här använder vi den första
          document.getElementById("bookingError").textContent = error.message;
        }
      }

      function parseDuration(duration) {
        console.log("Parsing duration:", duration); // Debug log
        const parts = duration.split(":");
        const hours = parseInt(parts[0], 10);
        const minutes = parseInt(parts[1], 10);
        return hours * 60 + minutes;
      }

      function loadServiceDetails() {
        const serviceId = document.getElementById("serviceId").value;
        console.log("Selected service ID:", serviceId); // Debug log

        if (!serviceId) {
          document.getElementById("serviceDetails").innerHTML = "";
          document.getElementById("bookingDate").disabled = true;
          return;
        }

        // Match selected service based on GUID
        selectedService = services.find(
          (s) => s.id.toLowerCase() === serviceId.toLowerCase()
        );

        if (!selectedService) {
          document.getElementById("serviceDetails").innerHTML = `
      <div style="color: red; margin-top: 5px;">
        Service not found
      </div>
    `;
          document.getElementById("bookingDate").disabled = true;
          return;
        }

        const durationMinutes = parseDuration(selectedService.duration);
        document.getElementById("serviceDetails").innerHTML = `
    <div style="margin-top: 5px;">
      <strong>${selectedService.name}</strong><br>
      Duration: ${durationMinutes} minutes<br>
      Price: ${selectedService.price} kr<br>
      Description: ${selectedService.description}
    </div>
  `;

        document.getElementById("bookingDate").disabled = false;
      }

      function loadServiceDetailsUpdate() {
        const serviceId = document.getElementById("serviceIdUpdate").value;
        console.log("Selected service ID for update:", serviceId);

        if (!serviceId) {
          document.getElementById("serviceDetailsUpdate").innerHTML = "";
          document.getElementById("bookingDateUpdate").disabled = true;
          return;
        }

        selectedService = services.find(
          (s) => s.id.toLowerCase() === serviceId.toLowerCase()
        );

        if (!selectedService) {
          document.getElementById("serviceDetailsUpdate").innerHTML = `
      <div style="color: red; margin-top: 5px;">
        Service not found
      </div>
    `;
          document.getElementById("bookingDateUpdate").disabled = true;
          return;
        }

        const durationMinutes = parseDuration(selectedService.duration);
        document.getElementById("serviceDetailsUpdate").innerHTML = `
    <div style="margin-top: 5px;">
      <strong>${selectedService.name}</strong><br>
      Duration: ${durationMinutes} minutes<br>
      Price: ${selectedService.price} kr<br>
      Description: ${selectedService.description}
    </div>
  `;
        document.getElementById("bookingDateUpdate").disabled = false;
      }

      async function loadAvailableSlots() {
        const serviceId = document.getElementById("serviceId").value;
        const date = document.getElementById("bookingDate").value;

        if (!serviceId || !date) return;

        try {
          const response = await fetch(
            `/api/Booking/available-time-slots?serviceId=${serviceId}&date=${date}`,
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to load available slots");
          }

          const timeSlotsData = await response.json();
          const timeSlotsContainer = document.getElementById("timeSlots");
          timeSlotsContainer.innerHTML = ""; // Rensa tidigare slots

          timeSlotsData.forEach((day) => {
            day.availableSlots.forEach((slot) => {
              if (slot.isAvailable) {
                const button = document.createElement("button");
                button.textContent = `${new Date(
                  slot.startTime
                ).toLocaleTimeString("sv-SE", {
                  hour: "2-digit",
                  minute: "2-digit",
                })} - ${new Date(slot.endTime).toLocaleTimeString("sv-SE", {
                  hour: "2-digit",
                  minute: "2-digit",
                })}`;
                button.onclick = () => selectTimeSlot(slot);
                timeSlotsContainer.appendChild(button);
              }
            });
          });

          document.getElementById("timeSlotsContainer").style.display = "block";
        } catch (error) {
          console.error("Error loading slots:", error);
          document.getElementById("bookingError").textContent = error.message;
        }
      }

      let selectedSlot = null;

      function selectTimeSlot(slot) {
        selectedSlot = slot;
        const buttons = document.querySelectorAll("#timeSlots button");
        buttons.forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");
        document.getElementById("bookButton").style.display = "block";
      }

      async function loadAvailableSlotsUpdate() {
        // Hämta värden från update‑elementen
        const serviceId = document.getElementById("serviceIdUpdate").value;
        const dateValue = document.getElementById("bookingDateUpdate").value;

        // Kontrollera att både service och datum är ifyllda
        if (!serviceId || !dateValue) return;

        const date = new Date(dateValue);

        try {
          const response = await fetch(
            `/api/Booking/available-time-slots?serviceId=${serviceId}&date=${date.toISOString()}`,
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to load available slots");
          }

          const timeSlotsData = await response.json();
          console.log("Available time slots for update:", timeSlotsData);

          const select = document.getElementById("timeSlotsUpdate");
          select.innerHTML = '<option value="">Select a time slot</option>';

          timeSlotsData.forEach((day) => {
            day.availableSlots.forEach((slot) => {
              if (slot.isAvailable) {
                const option = document.createElement("option");
                option.value = JSON.stringify({
                  startTime: slot.startTime,
                  endTime: slot.endTime,
                });
                const start = new Date(slot.startTime).toLocaleTimeString(
                  "sv-SE",
                  {
                    hour: "2-digit",
                    minute: "2-digit",
                  }
                );
                const end = new Date(slot.endTime).toLocaleTimeString("sv-SE", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                option.textContent = `${start} - ${end}`;
                select.appendChild(option);
              }
            });
          });

          select.style.display = "block";
          document.getElementById("bookButtonUpdate").style.display = "block";
        } catch (error) {
          console.error("Error loading available slots (update):", error);
          document.getElementById("bookingErrorUpdate").textContent =
            error.message;
        }
      }

      async function createTestBooking() {
        try {
          const serviceId = document.getElementById("serviceId").value;

          if (!selectedSlot) {
            throw new Error("Please select a time slot");
          }

          const bookingData = {
            userId: currentUserId || "test-user-id", // Placeholder för test
            serviceId: serviceId,
            startTime: selectedSlot.startTime,
            endTime: selectedSlot.endTime,
          };

          const response = await fetch("/api/Booking/CreateBooking", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify(bookingData),
          });

          if (!response.ok) {
            throw new Error("Failed to create booking");
          }

          alert("Booking created successfully!");
        } catch (error) {
          console.error("Error creating booking:", error);
          document.getElementById("bookingError").textContent = error.message;
        }
      }

      async function cancelBooking() {
        const bookingId = document.getElementById("bookingId").value;
        if (!bookingId) {
          alert("Please enter a booking ID");
          return;
        }

        try {
          const response = await fetch(
            `/api/Booking/CancelBooking/${bookingId}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to cancel booking");
          }

          alert("Booking cancelled successfully. Check notifications.");
        } catch (error) {
          console.error("Error cancelling booking:", error);
          alert("Error cancelling booking: " + error.message);
        }
      }

      async function updateBooking() {
        const bookingId = document.getElementById("bookingId").value;
        const serviceId = document.getElementById("serviceIdUpdate").value;
        const selectedSlotValue =
          document.getElementById("timeSlotsUpdate").value;

        if (!bookingId || !serviceId || !selectedSlotValue) {
          alert("Please fill all fields.");
          return;
        }

        try {
          const slot = JSON.parse(selectedSlotValue);
          // Skapa payloaden utan "id", då id:t ska vara en del av URL:en
          const bookingData = {
            startTime: slot.startTime,
            endTime: slot.endTime,
            serviceId: serviceId,
          };

          // Använd bookingId i URL:en
          const response = await fetch(
            `/api/Booking/UpdateBookingById/${bookingId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify(bookingData),
            }
          );

          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || "Failed to update booking.");
          }

          alert("Booking updated successfully.");
        } catch (error) {
          console.error("Error updating booking:", error);
          alert("Error updating booking: " + error.message);
        }
      }

      // Initialize the UI
      document.addEventListener("DOMContentLoaded", function () {
        showLoginSection();
      });
    </script>
  </body>
</html>
